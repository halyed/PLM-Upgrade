<div class="page-container" *ngIf="item() as item; else loading">
  <mat-card style="margin-bottom:16px">
    <mat-card-header>
      <mat-card-title>{{ item.name }}</mat-card-title>
      <mat-card-subtitle>{{ item.itemNumber }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content style="padding-top:8px">
      <p *ngIf="item.description">{{ item.description }}</p>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span class="status-chip {{ item.lifecycleState }}">{{ item.lifecycleState }}</span>
        <span style="color:#666;font-size:13px">Updated: {{ item.updatedAt | date:'medium' }}</span>
        <span class="spacer"></span>
        <mat-select placeholder="Transition lifecycle" style="width:200px" (selectionChange)="transitionLifecycle($event.value)">
          <mat-option value="IN_REVIEW">-> IN_REVIEW</mat-option>
          <mat-option value="RELEASED">-> RELEASED</mat-option>
          <mat-option value="OBSOLETE">-> OBSOLETE</mat-option>
          <mat-option value="DRAFT">-> DRAFT</mat-option>
        </mat-select>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Revisions -->
  <mat-expansion-panel [expanded]="true" style="margin-bottom:16px">
    <mat-expansion-panel-header>
      <mat-panel-title>Revisions ({{ revisions().length }})</mat-panel-title>
    </mat-expansion-panel-header>
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button mat-raised-button color="accent" (click)="nextRevision()">
        <mat-icon>add</mat-icon> Next Revision
      </button>
    </div>
    <table mat-table [dataSource]="revisions()" style="width:100%">
      <ng-container matColumnDef="revisionCode">
        <th mat-header-cell *matHeaderCellDef>Rev</th>
        <td mat-cell *matCellDef="let r"><strong>{{ r.revisionCode }}</strong></td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let r">
          <mat-select [value]="r.status" (selectionChange)="updateRevStatus(r, $event.value)" style="font-size:13px">
            <mat-option *ngFor="let s of revisionStatuses" [value]="s">{{ s }}</mat-option>
          </mat-select>
        </td>
      </ng-container>
      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef>Created</th>
        <td mat-cell *matCellDef="let r">{{ r.createdAt | date:'short' }}</td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let r">
          <button mat-button color="primary" (click)="selectRevision(r)"
                  [style.font-weight]="selectedRevision()?.id === r.id ? 'bold' : 'normal'">
            {{ selectedRevision()?.id === r.id ? '● Selected' : 'Select' }}
          </button>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="revCols"></tr>
      <tr mat-row *matRowDef="let row; columns: revCols;"></tr>
    </table>
  </mat-expansion-panel>

  <!-- BOM (shown when revision selected) -->
  @if (selectedRevision()) {
    <mat-expansion-panel [expanded]="true" style="margin-bottom:16px">
      <mat-expansion-panel-header>
        <mat-panel-title>BOM — Rev {{ selectedRevision()?.revisionCode }} ({{ bomChildren().length }} children)</mat-panel-title>
      </mat-expansion-panel-header>

      <form [formGroup]="bomForm" (ngSubmit)="addBomChild()" style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <mat-form-field appearance="outline" style="flex:1">
          <mat-label>Child Revision ID</mat-label>
          <input matInput formControlName="childRevisionId" type="number">
        </mat-form-field>
        <mat-form-field appearance="outline" style="width:120px">
          <mat-label>Qty</mat-label>
          <input matInput formControlName="quantity" type="number" step="0.0001">
        </mat-form-field>
        <button mat-raised-button color="primary" type="submit" [disabled]="bomForm.invalid">Add</button>
      </form>

      <table mat-table [dataSource]="bomChildren()" style="width:100%">
        <ng-container matColumnDef="childItemNumber">
          <th mat-header-cell *matHeaderCellDef>Item #</th>
          <td mat-cell *matCellDef="let row">{{ row.childItemNumber }}</td>
        </ng-container>
        <ng-container matColumnDef="childRevisionCode">
          <th mat-header-cell *matHeaderCellDef>Rev</th>
          <td mat-cell *matCellDef="let row">{{ row.childRevisionCode }}</td>
        </ng-container>
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Qty</th>
          <td mat-cell *matCellDef="let row">{{ row.quantity }}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="warn" (click)="removeBomChild(row)"><mat-icon>delete</mat-icon></button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="bomCols"></tr>
        <tr mat-row *matRowDef="let row; columns: bomCols;"></tr>
      </table>
    </mat-expansion-panel>

    <!-- Documents -->
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Documents — Rev {{ selectedRevision()?.revisionCode }} ({{ documents().length }})</mat-panel-title>
      </mat-expansion-panel-header>

      <div style="margin-bottom:12px">
        <label>
          <input type="file" hidden (change)="uploadFile($event)">
          <button mat-raised-button color="accent" component="label" onclick="this.previousElementSibling.click()">
            <mat-icon>upload</mat-icon> Upload File
          </button>
        </label>
      </div>

      <table mat-table [dataSource]="documents()" style="width:100%">
        <ng-container matColumnDef="fileName">
          <th mat-header-cell *matHeaderCellDef>File</th>
          <td mat-cell *matCellDef="let d">{{ d.fileName }}</td>
        </ng-container>
        <ng-container matColumnDef="fileType">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let d"><span class="status-chip">{{ d.fileType }}</span></td>
        </ng-container>
        <ng-container matColumnDef="uploadedAt">
          <th mat-header-cell *matHeaderCellDef>Uploaded</th>
          <td mat-cell *matCellDef="let d">{{ d.uploadedAt | date:'short' }}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let d">
            <a mat-icon-button [routerLink]="['/viewer', d.id]"
               *ngIf="isViewable(d.fileType)"
               matTooltip="View 3D">
              <mat-icon style="color:#7c4dff">view_in_ar</mat-icon>
            </a>
            <button mat-icon-button color="warn" (click)="deleteDoc(d)"><mat-icon>delete</mat-icon></button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="docCols"></tr>
        <tr mat-row *matRowDef="let row; columns: docCols;"></tr>
      </table>
    </mat-expansion-panel>
  }
</div>

<ng-template #loading>
  <div style="text-align:center;padding:64px">
    <mat-spinner diameter="40" style="margin:auto"></mat-spinner>
  </div>
</ng-template>
